trigger:
- main

pool:
  name: SelfHostedPool

variables:
  IMAGE_NAME: "projectx-webapp"
  ACR_NAME: "mohanxacr"
  RESOURCE_GROUP: "ProjectX-RG"
  QA_CONTAINER: "projectx-qa"
  PROD_CONTAINER: "projectx-prod"
  # Note: ACR_USERNAME and ACR_PASSWORD should be set as Secret Variables
  # in the Azure DevOps Pipeline Library or Pipeline UI.

stages:

# ================================================================
#          BUILD STAGE
# ================================================================
- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: BuildJob
    steps:
    - task: Maven@3
      displayName: "Build WAR using Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"
        javaHomeOption: "Path"
        # Ensure this path is correct for your Self-Hosted Agent environment
        jdkDirectory: "/usr/lib/jvm/java-17-openjdk-amd64"

    - task: CopyFiles@2
      displayName: "Copy WAR to staging"
      inputs:
        Contents: "target/*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    - task: PublishBuildArtifacts@1
      displayName: "Publish WAR artifact"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)"
        ArtifactName: "warfiles"
        publishLocation: "Container"

---

# ================================================================
#          DOCKER BUILD & PUSH
# ================================================================
- stage: Docker
  displayName: "Build & Push Docker Image"
  dependsOn: Build
  jobs:
  - job: DockerJob
    steps:
    - download: current
      artifact: warfiles

    - script: |
        echo "=== Preparing Dockerfile and WAR ==="
        # Assuming the WAR file name is "webapp.war" based on the copy/publish step
        # If your Maven build outputs a different name, adjust the name below.
        find "$(Pipeline.Workspace)/warfiles" -name "*.war" -exec cp {} . \;
        
        # Determine the name of the copied WAR file for use in the Dockerfile
        WAR_FILE_NAME=$(find . -maxdepth 1 -name "*.war" | head -n 1 | xargs basename)
        
        # Dynamically create Dockerfile
        cat > Dockerfile <<EOF
        FROM tomcat:9.0
        COPY $WAR_FILE_NAME /usr/local/tomcat/webapps/ROOT.war
        EOF

        echo "=== Building Docker image ==="
        docker build -t "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" .

        # NOTE: You should ensure 'az login' or a service principal configuration 
        # is performed before 'az acr login' on a self-hosted agent if it's 
        # not already configured. For simplicity, we assume 'az acr login' 
        # is authenticated via existing credentials or permissions.
        echo "=== Logging into ACR ==="
        az acr login --name "$(ACR_NAME)"

        echo "=== Tagging image ==="
        docker tag "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" \
                     "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest"

        echo "=== Pushing image to ACR ==="
        docker push "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)"
        docker push "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest"
      displayName: "Build & Push Docker Image"

---

# ================================================================
#          QA DEPLOYMENT STAGE (FIXED)
# ================================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Docker
  jobs:
  - job: QADeploy
    steps:
    - script: |
        echo "=== Deploying to QA ==="
        # FIX: Added '\' for line continuation to resolve the unclosed quote error.
        az container create \
          --resource-group "$(RESOURCE_GROUP)" \
          --name "$(QA_CONTAINER)" \
          --image "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" \
          --registry-login-server "$(ACR_NAME).azurecr.io" \
          --registry-username "$(ACR_USERNAME)" \
          --registry-password "$(ACR_PASSWORD)" \
          --restart-policy Always \
          --ports 8080
      displayName: "Deploy to QA ACI"

---

# ================================================================
#          PROD DEPLOYMENT STAGE (FIXED)
# ================================================================
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_QA
  jobs:
  - job: ProdDeploy
    steps:
    - script: |
        echo "=== Deploying to PROD ==="
        # FIX: Added '\' for line continuation to resolve the unclosed quote error.
        az container create \
          --resource-group "$(RESOURCE_GROUP)" \
          --name "$(PROD_CONTAINER)" \
          --image "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" \
          --registry-login-server "$(ACR_NAME).azurecr.io" \
          --registry-username "$(ACR_USERNAME)" \
          --registry-password "$(ACR_PASSWORD)" \
          --restart-policy Always \
          --ports 8080
      displayName: "Deploy to PROD ACI"
