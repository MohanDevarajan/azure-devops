trigger:
  branches:
    include:
      - main

pool:
  name: SelfHostedAgents

variables:
  containerNameQA: "projectx-qa"
  containerNamePROD: "projectx-prod"
  resourceGroup: "ProjectX-RG"
  warFile: "$(Build.SourcesDirectory)/target/webapp.war"

stages:

# =============================
# BUILD STAGE
# =============================
- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: Build
    steps:
    - task: Maven@3
      inputs:
        mavenPomFile: "pom.xml"
        goals: "package"
        options: "-DskipTests"
        publishJUnitResults: true

    - task: CopyFiles@2
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)/target"
        Contents: "*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)/warfiles"

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: "$(Build.ArtifactStagingDirectory)/warfiles"
        artifactName: "drop"

# =============================
# QA DEPLOYMENT
# =============================
- stage: DeployQA
  displayName: "Deploy to QA"
  dependsOn: Build
  jobs:
  - deployment: DeployToQA
    displayName: "Deploy to QA Container"
    environment: projectx-qa   # <-- FIXED NAME
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - script: |
              echo "=== Deploying to QA ==="

              WAR="$(Pipeline.Workspace)/drop/webapp.war"
              echo "WAR FOUND: $WAR"

              echo "Creating tar..."
              tar -cvf webapp.tar -C "$(Pipeline.Workspace)/drop" webapp.war

              echo "Copying into container..."
              az container exec \
                --name projectx-qa \
                --resource-group ProjectX-RG \
                --exec-command "/bin/sh -c 'mkdir -p /tmp/deploy'"

              cat webapp.tar | az container exec \
                --name projectx-qa \
                --resource-group ProjectX-RG \
                --exec-command "/bin/sh -c 'tar -xvf - -C /tmp/deploy' --interactive=false"

              echo "Moving WAR to Tomcat..."
              az container exec \
                --name projectx-qa \
                --resource-group ProjectX-RG \
                --exec-command "/bin/sh -c 'mv /tmp/deploy/webapp.war /usr/local/tomcat/webapps/ROOT.war'"

              echo "Restarting container..."
              az container restart --name projectx-qa --resource-group ProjectX-RG

            displayName: "Deploy WAR to QA"

# =============================
# PROD DEPLOYMENT
# =============================
- stage: DeployPROD
  displayName: "Deploy to PROD"
  dependsOn: DeployQA
  condition: succeeded()
  jobs:
  - deployment: DeployToPROD
    displayName: "Deploy to PROD Container"
    environment: projectx-prod   # <-- FIXED NAME
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - script: |
              echo "=== Deploying to PROD ==="

              WAR="$(Pipeline.Workspace)/drop/webapp.war"
              tar -cvf webapp.tar -C "$(Pipeline.Workspace)/drop" webapp.war

              az container exec \
                --name projectx-prod \
                --resource-group ProjectX-RG \
                --exec-command "/bin/sh -c 'mkdir -p /tmp/deploy'"

              cat webapp.tar | az container exec \
                --name projectx-prod \
                --resource-group ProjectX-RG \
                --exec-command "/bin/sh -c 'tar -xvf - -C /tmp/deploy' --interactive=false"

              az container exec \
                --name projectx-prod \
                --resource-group ProjectX-RG \
                --exec-command "/bin/sh -c 'mv /tmp/deploy/webapp.war /usr/local/tomcat/webapps/ROOT.war'"

              az container restart --name projectx-prod --resource-group ProjectX-RG

            displayName: "Deploy WAR to PROD"
