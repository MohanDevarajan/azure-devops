trigger:
  - main

pool:
  name: SelfHostedPool

variables:
  artifactName: 'warfiles'

stages:

# ================================================================
#  BUILD
# ================================================================
- stage: Build
  displayName: Build Java Project
  jobs:
    - job: MavenBuild
      displayName: Maven Build Job
      steps:

        - task: Maven@3
          displayName: Build WAR using Maven
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package'

        - task: CopyFiles@2
          displayName: Copy WAR to artifact folder
          inputs:
            SourceFolder: '$(System.DefaultWorkingDirectory)'
            Contents: '**/*.war'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/$(artifactName)'

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName)'
            ArtifactName: '$(artifactName)'


# ================================================================
#  QA DEPLOY
# ================================================================
- stage: QA
  displayName: Deploy to QA
  dependsOn: Build

  jobs:
    - deployment: DeployToQA
      displayName: Deploy WAR to QA
      environment: ProjectX-QA      # ✔ VALID HERE
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: warfiles

              - task: CmdLine@2
                displayName: Deploy WAR to QA via HTTP
                inputs:
                  script: |
                    echo "=== Locating WAR file ==="
                    WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)
                    echo "Found WAR: $WAR_PATH"

                    AGENT_IP=$(hostname -I | awk '{print $1}')
                    echo "Agent IP: $AGENT_IP"

                    echo "=== Starting temp HTTP server ==="
                    cd "$(dirname "$WAR_PATH")"
                    python3 -m http.server 9000 &
                    HTTP_PID=$!
                    sleep 3

                    echo "=== Downloading WAR inside container ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-qa \
                      --exec-command "curl -L -o /usr/local/tomcat/webapps/ROOT.war http://$AGENT_IP:9000/$(basename "$WAR_PATH")"

                    echo "=== Stopping HTTP server ==="
                    kill $HTTP_PID

                    echo "=== Restarting QA container ==="
                    az container restart \
                      --resource-group ProjectX-RG \
                      --name projectx-qa


# ================================================================
#  PROD DEPLOY
# ================================================================
- stage: PROD
  displayName: Deploy to PROD
  dependsOn: QA

  jobs:
    - deployment: DeployToProd
      displayName: Deploy WAR to PROD
      environment: ProjectX-PROD       # ✔ VALID HERE
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: warfiles

              - task: CmdLine@2
                displayName: Deploy WAR to PROD via HTTP
                inputs:
                  script: |
                    echo "=== Locating WAR file ==="
                    WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)
                    echo "Found WAR: $WAR_PATH"

                    AGENT_IP=$(hostname -I | awk '{print $1}')
                    echo "Agent IP: $AGENT_IP"

                    echo "=== Starting temp HTTP server ==="
                    cd "$(dirname "$WAR_PATH")"
                    python3 -m http.server 9000 &
                    HTTP_PID=$!
                    sleep 3

                    echo "=== Downloading WAR inside container ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-prod \
                      --exec-command "curl -L -o /usr/local/tomcat/webapps/ROOT.war http://$AGENT_IP:9000/$(basename "$WAR_PATH")"

                    echo "=== Stopping HTTP server ==="
                    kill $HTTP_PID

                    echo "=== Restarting PROD container ==="
                    az container restart \
                      --resource-group ProjectX-RG \
                      --name projectx-prod
