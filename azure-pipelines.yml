trigger:
- main

pool:
  name: SelfHostedPool

stages:

# ======================================================
# BUILD STAGE
# ======================================================
- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: BuildJob
    displayName: "Maven Build"
    steps:

    # --- Debug workspace to verify correct folders ---
    - script: |
        echo "=== Workspace before build ==="
        ls -R $(Build.SourcesDirectory)
      displayName: "Debug Workspace"

    # --- Install Java (self-hosted needs this) ---
    - task: JavaToolInstaller@0
      displayName: "Install JDK 17"
      inputs:
        versionSpec: "17"
        jdkSourceOption: "PreInstalled"

    # --- Maven build ---
    - task: Maven@3
      displayName: "Build WAR with Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"
        options: "-DskipTests"
        publishJUnitResults: true

    # --- Confirm target folder exists ---
    - script: |
        echo "=== Listing target directory ==="
        ls -R $(Build.SourcesDirectory)/target || echo "‚ùå target folder missing!"
      displayName: "Verify target folder"

    # --- Copy WAR as artifact ---
    - task: CopyFiles@2
      displayName: "Copy WAR to staging"
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)/target"
        Contents: "*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    # --- Publish artifact ---
    - task: PublishBuildArtifacts@1
      displayName: "Publish WAR Artifact"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)"
        ArtifactName: "warfiles"
        publishLocation: "Container"

# ======================================================
# DEPLOY TO QA
# ======================================================
- stage: DeployQA
  displayName: "Deploy to QA"
  dependsOn: Build
  environment: projectx-qa
  jobs:
  - job: DeployToQA
    displayName: "Deploy WAR to QA"
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "=== Extract WAR Path ==="
        WAR=$(ls $(Pipeline.Workspace)/warfiles/*.war)
        echo "WAR found at: $WAR"

        echo "=== Creating TAR package ==="
        tar -cvf webapp.tar -C $(Pipeline.Workspace)/warfiles $(basename $WAR)

        echo "=== Sending tar into QA container ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "mkdir -p /tmp/deploy"

        cat webapp.tar | az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "tar -xvf - -C /tmp/deploy"

        echo "=== Deploying WAR inside container ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "mv /tmp/deploy/*.war /usr/local/tomcat/webapps/ROOT.war"

        echo "=== Restarting container ==="
        az container restart \
          --resource-group ProjectX-RG \
          --name projectx-qa
      displayName: "Deploy WAR to QA over TAR upload"

# ======================================================
# DEPLOY TO PROD
# ======================================================
- stage: DeployPROD
  displayName: "Deploy to PROD"
  dependsOn: DeployQA
  environment: projectx-prod
  jobs:
  - job: DeployToProd
    displayName: "Deploy WAR to PROD"
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "=== Extract WAR Path ==="
        WAR=$(ls $(Pipeline.Workspace)/warfiles/*.war)
        echo "WAR found at: $WAR"

        echo "=== Creating TAR package ==="
        tar -cvf webapp.tar -C $(Pipeline.Workspace)/warfiles $(basename $WAR)

        echo "=== Sending tar into PROD container ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "mkdir -p /tmp/deploy"

        cat webapp.tar | az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "tar -xvf - -C /tmp/deploy"

        echo "=== Deploying WAR inside container ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "mv /tmp/deploy/*.war /usr/local/tomcat/webapps/ROOT.war"

        echo "=== Restarting container ==="
        az container restart \
          --resource-group ProjectX-RG \
          --name projectx-prod
      displayName: "Deploy WAR to PROD over TAR upload"
