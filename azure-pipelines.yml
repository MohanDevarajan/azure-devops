trigger:
- main

pool:
  name: SelfHostedPool

stages:

# --------------------------------------------------------
# BUILD STAGE
# --------------------------------------------------------
- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: BuildJob
    displayName: "Maven Build"
    steps:

    - script: |
        echo "=== Workspace before build ==="
        ls -R $(Build.SourcesDirectory)
      displayName: "Debug Workspace"

    - task: JavaToolInstaller@0
      displayName: "Install JDK 17"
      inputs:
        versionSpec: "17"
        jdkSourceOption: "PreInstalled"

    - task: Maven@3
      displayName: "Build WAR with Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"
        publishJUnitResults: false

    - script: |
        echo "=== Listing target directory ==="
        ls -R $(Build.SourcesDirectory)/target
      displayName: "Verify target folder"

    - task: CopyFiles@2
      displayName: "Copy WAR to staging"
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)/target"
        Contents: "*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    - task: PublishBuildArtifacts@1
      displayName: "Publish WAR Artifact"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)"
        ArtifactName: "warfiles"
        publishLocation: "Container"

# --------------------------------------------------------
# DEPLOY QA
# --------------------------------------------------------
- stage: DeployQA
  displayName: "Deploy to QA"
  dependsOn: Build

  jobs:
  - deployment: DeployToQA
    displayName: "Deploy to QA Container"
    environment: projectx-qa

    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: warfiles

          - script: |
              WAR=$(ls $(Pipeline.Workspace)/warfiles/*.war)
              echo "WAR found: $WAR"

              tar -cvf webapp.tar -C $(Pipeline.Workspace)/warfiles $(basename $WAR)

              az container exec \
                 --resource-group ProjectX-RG \
                 --name projectx-qa \
                 --exec-command "mkdir -p /tmp/deploy"

              cat webapp.tar | az container exec \
                 --resource-group ProjectX-RG \
                 --name projectx-qa \
                 --exec-command "tar -xvf - -C /tmp/deploy"

              az container exec \
                 --resource-group ProjectX-RG \
                 --name projectx-qa \
                 --exec-command "mv /tmp/deploy/*.war /usr/local/tomcat/webapps/ROOT.war"

              az container restart \
                 --resource-group ProjectX-RG \
                 --name projectx-qa
            displayName: "Deploy WAR to QA"

# --------------------------------------------------------
# DEPLOY PROD
# --------------------------------------------------------
- stage: DeployPROD
  displayName: "Deploy to PROD"
  dependsOn: DeployQA

  jobs:
  - deployment: DeployToProd
    displayName: "Deploy to PROD Container"
    environment: projectx-prod

    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: warfiles

          - script: |
              WAR=$(ls $(Pipeline.Workspace)/warfiles/*.war)
              echo "WAR found: $WAR"

              tar -cvf webapp.tar -C $(Pipeline.Workspace)/warfiles $(basename $WAR)

              az container exec \
                 --resource-group ProjectX-RG \
                 --name projectx-prod \
                 --exec-command "mkdir -p /tmp/deploy"

              cat webapp.tar | az container exec \
                 --resource-group ProjectX-RG \
                 --name projectx-prod \
                 --exec-command "tar -xvf - -C /tmp/deploy"

              az container exec \
                 --resource-group ProjectX-RG \
                 --name projectx-prod \
                 --exec-command "mv /tmp/deploy/*.war /usr/local/tomcat/webapps/ROOT.war"

              az container restart \
                 --resource-group ProjectX-RG \
                 --name projectx-prod
            displayName: "Deploy WAR to PROD"
