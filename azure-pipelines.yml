trigger:
  - main

pool:
  name: SelfHostedPool

variables:
  artifactName: 'warfiles'

stages:

# ================================================================
#  BUILD STAGE
# ================================================================
- stage: Build
  displayName: Build Java Project
  jobs:
    - job: MavenBuild
      displayName: Maven Build Job
      steps:

        - task: Maven@3
          displayName: Build WAR using Maven
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package'

        - task: CopyFiles@2
          displayName: Copy WAR to artifact folder
          inputs:
            SourceFolder: '$(System.DefaultWorkingDirectory)'
            Contents: '**/*.war'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/$(artifactName)'

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName)'
            ArtifactName: '$(artifactName)'


# ================================================================
#  QA DEPLOY STAGE (Deploy WAR into ACI via tar upload)
# ================================================================
- stage: QA
  displayName: Deploy to QA
  dependsOn: Build

  jobs:
    - deployment: DeployToQA
      displayName: Deploy WAR to QA
      environment: projectx-qa     # Your Azure DevOps environment
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: warfiles

              - task: CmdLine@2
                displayName: Deploy WAR to QA (tar upload)
                inputs:
                  script: |
                    echo "=== Locating WAR file ==="
                    WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)
                    echo "WAR Found: $WAR_PATH"

                    echo "=== Creating TAR archive ==="
                    TAR_PATH="/tmp/deploy.tar"
                    tar -cvf $TAR_PATH -C "$(dirname "$WAR_PATH")" "$(basename "$WAR_PATH")"

                    echo "=== Creating directory inside container ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-qa \
                      --exec-command "mkdir -p /tmp/deploy"

                    echo "=== Uploading TAR to container via stdin ==="
                    cat "$TAR_PATH" | \
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-qa \
                      --exec-command "tar -xvf - -C /tmp/deploy"

                    echo "=== Moving WAR into Tomcat webapps ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-qa \
                      --exec-command "mv /tmp/deploy/*.war /usr/local/tomcat/webapps/ROOT.war"

                    echo "=== Restarting QA container ==="
                    az container restart \
                      --resource-group ProjectX-RG \
                      --name projectx-qa



# ================================================================
#  PROD DEPLOY STAGE (manual approval in Azure DevOps)
# ================================================================
- stage: PROD
  displayName: Deploy to PROD
  dependsOn: QA

  jobs:
    - deployment: DeployToProd
      displayName: Deploy WAR to PROD
      environment: projectx-prod     # Approval controlled in DevOps UI
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: warfiles

              - task: CmdLine@2
                displayName: Deploy WAR to PROD (tar upload)
                inputs:
                  script: |
                    echo "=== Locating WAR file ==="
                    WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)
                    echo "WAR Found: $WAR_PATH"

                    echo "=== Creating TAR archive ==="
                    TAR_PATH="/tmp/deploy.tar"
                    tar -cvf $TAR_PATH -C "$(dirname "$WAR_PATH")" "$(basename "$WAR_PATH")"

                    echo "=== Creating directory inside container ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-prod \
                      --exec-command "mkdir -p /tmp/deploy"

                    echo "=== Uploading TAR to container via stdin ==="
                    cat "$TAR_PATH" | \
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-prod \
                      --exec-command "tar -xvf - -C /tmp/deploy"

                    echo "=== Moving WAR into Tomcat webapps ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-prod \
                      --exec-command "mv /tmp/deploy/*.war /usr/local/tomcat/webapps/ROOT.war"

                    echo "=== Restarting PROD container ==="
                    az container restart \
                      --resource-group ProjectX-RG \
                      --name projectx-prod
