trigger:
- main

pool:
  name: SelfHostedPool

variables:
  WAR_NAME: "webapp.war"

stages:

# ================================================================
#                           BUILD STAGE
# ================================================================
- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: BuildJob
    displayName: "Compile and Package"
    steps:

    # Build using the JDK already installed on your self-hosted agent
    - task: Maven@3
      displayName: "Build WAR using Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"
        publishJUnitResults: true
        testResultsFiles: "**/surefire-reports/TEST-*.xml"
        javaHomeOption: "Path"
        jdkDirectory: "/usr/lib/jvm/java-17-openjdk-amd64"

    # Copy WAR to artifact staging
    - task: CopyFiles@2
      displayName: "Copy WAR to staging"
      inputs:
        Contents: "target/*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    - task: PublishBuildArtifacts@1
      displayName: "Publish WAR artifact"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)"
        ArtifactName: "warfiles"
        publishLocation: "Container"


# ================================================================
#                      QA DEPLOYMENT STAGE
# ================================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Build
  jobs:
  - job: QADeploy
    displayName: "Deployment to QA ACI"
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "=== Locating WAR file ==="
        WAR_FILE=$(find $(Pipeline.Workspace)/warfiles -name "*.war" | head -n 1)
        echo "WAR found: $WAR_FILE"

        echo "=== Encoding WAR to base64 ==="
        base64 "$WAR_FILE" > war.b64

        echo "=== Uploading WAR into QA container ==="
        cat war.b64 | az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "/bin/sh -c 'base64 -d > /usr/local/tomcat/webapps/ROOT.war'"

        echo "=== Restarting QA container ==="
        az container restart \
          --resource-group ProjectX-RG \
          --name projectx-qa
      displayName: "Deploy WAR to QA"


# ================================================================
#                      PROD DEPLOYMENT STAGE
# ================================================================
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_QA
  # (If you want manual approval, add environment in UI)
  jobs:
  - job: ProdDeploy
    displayName: "Deployment to PROD ACI"
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "=== Locating WAR file ==="
        WAR_FILE=$(find $(Pipeline.Workspace)/warfiles -name "*.war" | head -n 1)
        echo "WAR found: $WAR_FILE"

        echo "=== Encoding WAR to base64 ==="
        base64 "$WAR_FILE" > war.b64

        echo "=== Uploading WAR into PROD container ==="
        cat war.b64 | az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "/bin/sh -c 'base64 -d > /usr/local/tomcat/webapps/ROOT.war'"

        echo "=== Restarting PROD container ==="
        az container restart \
          --resource-group ProjectX-RG \
          --name projectx-prod
      displayName: "Deploy WAR to PROD"
