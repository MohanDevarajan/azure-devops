trigger:
- main

pool:
  name: SelfHostedPool

variables:
  IMAGE_NAME: "projectx-webapp"
  ACR_NAME: "mohanxacr"
  RESOURCE_GROUP: "ProjectX-RG"
  QA_CONTAINER: "projectx-qa"
  PROD_CONTAINER: "projectx-prod"

# =====================================================================
#                              BUILD STAGE
# =====================================================================
stages:

- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: BuildJob
    steps:
    - task: Maven@3
      displayName: "Build WAR using Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"
        javaHomeOption: "Path"
        jdkDirectory: "/usr/lib/jvm/java-17-openjdk-amd64"

    - task: CopyFiles@2
      displayName: "Copy WAR to staging"
      inputs:
        Contents: "target/*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    - task: PublishBuildArtifacts@1
      displayName: "Publish WAR artifact"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)"
        ArtifactName: "warfiles"
        publishLocation: "Container"


# =====================================================================
#                        DOCKER BUILD & PUSH
# =====================================================================
- stage: Docker
  displayName: "Build & Push Docker Image"
  dependsOn: Build

  jobs:
  - job: DockerJob
    steps:
    - download: current
      artifact: warfiles

    - script: |
        echo "=== Preparing WAR and Dockerfile ==="
        cp $(Pipeline.Workspace)/warfiles/*.war .

        WAR_FILE_NAME=$(ls *.war)

        echo "FROM tomcat:9.0" > Dockerfile
        echo "COPY ${WAR_FILE_NAME} /usr/local/tomcat/webapps/ROOT.war" >> Dockerfile

        echo "=== Building Docker image ==="
        docker build -t "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" .

        echo "=== Logging into ACR ==="
        az acr login --name "$(ACR_NAME)"

        echo "=== Tagging & Pushing Image ==="
        docker tag "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" \
                   "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest"

        docker push "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)"
        docker push "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest"
      displayName: "Build & Push Docker Image"


# =====================================================================
#                        QA DEPLOYMENT (ENVIRONMENT)
# =====================================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Docker

  jobs:
  - deployment: QADeploy
    displayName: "Deploy to QA ACI"
    environment: "projectx-qa"

    strategy:
      runOnce:
        deploy:
          steps:

          # ------------------------------
          # Delete old container
          # ------------------------------
          - script: |
              echo "=== Deleting Existing QA Container ==="
              az container delete \
                --resource-group "$(RESOURCE_GROUP)" \
                --name "$(QA_CONTAINER)" \
                --yes
            displayName: "Delete Old QA Container"

          # ------------------------------
          # Create fresh container
          # ------------------------------
          - script: |
              echo "=== Deploying NEW QA Container ==="

              az container create \
                --resource-group "$(RESOURCE_GROUP)" \
                --name "$(QA_CONTAINER)" \
                --image "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" \
                --registry-login-server "$(ACR_NAME).azurecr.io" \
                --registry-username "$(ACR_USERNAME)" \
                --registry-password "$(ACR_PASSWORD)" \
                --restart-policy Always \
                --os-type Linux \
                --cpu 1 \
                --memory 1.5 \
                --ports 8080 \
                --ip-address Public

              QA_IP=$(az container show \
                        --resource-group "$(RESOURCE_GROUP)" \
                        --name "$(QA_CONTAINER)" \
                        --query "ipAddress.ip" -o tsv)

              echo "##vso[task.setvariable variable=QA_URL]http://$QA_IP:8080"
              echo "QA URL = http://$QA_IP:8080"
            displayName: "Create QA Container"

          # ------------------------------
          # Notify QA deploy success
          # ------------------------------
          - script: |
              echo "QA deployment completed successfully: $(QA_URL)"
            displayName: "Post Deployment Notification"


# =====================================================================
#                      MANUAL APPROVAL → PROD  
# =====================================================================

# Add approval in UI:
# Pipelines → Environments → projectx-prod → Approvals & checks → Add Approval

# =====================================================================
#                        PROD DEPLOYMENT (ENVIRONMENT)
# =====================================================================
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_QA

  jobs:
  - deployment: ProdDeploy
    displayName: "Deploy to PROD ACI"
    environment: "projectx-prod"

    strategy:
      runOnce:
        deploy:
          steps:

          # ------------------------------
          # Rollback point: save current image
          # ------------------------------
          - script: |
              echo "Fetching CURRENT PROD image for rollback..."
              CURRENT_IMAGE=$(az container show \
                --resource-group "$(RESOURCE_GROUP)" \
                --name "$(PROD_CONTAINER)" \
                --query "containers[0].image" -o tsv)

              echo "##vso[task.setvariable variable=ROLLBACK_IMAGE]$CURRENT_IMAGE"
              echo "Rollback Image Saved: $CURRENT_IMAGE"
            displayName: "Save Rollback Image"

          # ------------------------------
          # Delete old container
          # ------------------------------
          - script: |
              echo "=== Deleting Existing PROD Container ==="
              az container delete \
                --resource-group "$(RESOURCE_GROUP)" \
                --name "$(PROD_CONTAINER)" \
                --yes
            displayName: "Delete Old PROD Container"

          # ------------------------------
          # Create new PROD container
          # ------------------------------
          - script: |
              echo "=== Deploying NEW PROD Container ==="

              az container create \
                --resource-group "$(RESOURCE_GROUP)" \
                --name "$(PROD_CONTAINER)" \
                --image "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)" \
                --registry-login-server "$(ACR_NAME).azurecr.io" \
                --registry-username "$(ACR_USERNAME)" \
                --registry-password "$(ACR_PASSWORD)" \
                --restart-policy Always \
                --os-type Linux \
                --cpu 1 \
                --memory 1.5 \
                --ports 8080 \
                --ip-address Public

              PROD_IP=$(az container show \
                        --resource-group "$(RESOURCE_GROUP)" \
                        --name "$(PROD_CONTAINER)" \
                        --query "ipAddress.ip" -o tsv)

              echo "##vso[task.setvariable variable=PROD_URL]http://$PROD_IP:8080"
              echo "PROD URL = http://$PROD_IP:8080"
            displayName: "Create PROD Container"

          # ------------------------------
          # Rollback script
          # ------------------------------
          - script: |
              echo "Rollback script ready."
              echo "If needed, run:"
              echo "az container create --resource-group $(RESOURCE_GROUP) --name $(PROD_CONTAINER) --image $(ROLLBACK_IMAGE)"
            displayName: "Rollback Info"

          # ------------------------------
          # Notify PROD deploy success
          # ------------------------------
          - script: |
              echo "PROD deployment completed successfully: $(PROD_URL)"
            displayName: "Post Deployment Notification"
