trigger:
- main

pool:
  name: SelfHostedPool

variables:
  WAR_NAME: "webapp.war"

stages:

# ================================================================
#                           BUILD STAGE
# ================================================================
- stage: Build
  displayName: "Build Java WAR"
  jobs:
  - job: BuildJob
    displayName: "Compile & Package"
    steps:

    - task: JavaToolInstaller@0
      displayName: "Install JDK 17"
      inputs:
        versionSpec: "17"
        jdkArchitectureOption: "x64"
        jdkSourceOption: "PreInstalled"

    - task: Maven@3
      displayName: "Build WAR using Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"
        publishJUnitResults: true
        testResultsFiles: "**/surefire-reports/TEST-*.xml"

    # Copy the WAR to artifact staging
    - task: CopyFiles@2
      displayName: "Copy WAR to staging"
      inputs:
        Contents: "target/*.war"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    - task: PublishBuildArtifacts@1
      displayName: "Publish WAR artifact"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)"
        ArtifactName: "warfiles"
        publishLocation: "Container"

# ================================================================
#                      DEPLOY TO QA STAGE
# ================================================================
- stage: Deploy_QA
  displayName: "Deploy to QA Container"
  dependsOn: Build
  jobs:
  - job: QADeploy
    displayName: "QA Deployment"
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "=== Locating WAR ==="
        WAR_PATH=$(find $(Pipeline.Workspace)/warfiles -name "*.war" | head -n 1)
        echo "WAR found: $WAR_PATH"

        echo "=== Creating TAR ==="
        mkdir tarbuild
        cp "$WAR_PATH" tarbuild/webapp.war
        tar -cvf deploy.tar -C tarbuild webapp.war

        echo "=== Creating directory inside container ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "mkdir -p /tmp/deploy"

        echo "=== Uploading TAR (stdin) ==="
        cat deploy.tar | az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "tar -xvf - -C /tmp/deploy"

        echo "=== Moving WAR to Tomcat webapps ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-qa \
          --exec-command "mv /tmp/deploy/webapp.war /usr/local/tomcat/webapps/ROOT.war"

        echo "=== Restarting QA container ==="
        az container restart \
          --resource-group ProjectX-RG \
          --name projectx-qa

      displayName: "Deploy WAR to QA"

# ================================================================
#                      DEPLOY TO PROD STAGE
# ================================================================
- stage: Deploy_Prod
  displayName: "Deploy to PROD Container"
  dependsOn: Deploy_QA
  jobs:
  - job: ProdDeploy
    displayName: "Production Deployment"
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "=== Locating WAR ==="
        WAR_PATH=$(find $(Pipeline.Workspace)/warfiles -name "*.war" | head -n 1)
        echo "WAR found: $WAR_PATH"

        echo "=== Creating TAR ==="
        mkdir tarbuild
        cp "$WAR_PATH" tarbuild/webapp.war
        tar -cvf deploy.tar -C tarbuild webapp.war

        echo "=== Creating directory inside container ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "mkdir -p /tmp/deploy"

        echo "=== Uploading TAR (stdin) ==="
        cat deploy.tar | az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "tar -xvf - -C /tmp/deploy"

        echo "=== Moving WAR to Tomcat webapps ==="
        az container exec \
          --resource-group ProjectX-RG \
          --name projectx-prod \
          --exec-command "mv /tmp/deploy/webapp.war /usr/local/tomcat/webapps/ROOT.war"

        echo "=== Restarting PROD container ==="
        az container restart \
          --resource-group ProjectX-RG \
          --name projectx-prod

      displayName: "Deploy WAR to PROD"
