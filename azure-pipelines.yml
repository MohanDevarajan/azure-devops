trigger:
  - main

pool:
  name: SelfHostedPool   # your private agent pool

variables:
  javaVersion: '17'
  artifactName: 'warfiles'

stages:

# ================================================================
#  BUILD STAGE
# ================================================================
- stage: Build
  displayName: Build Java Project
  jobs:
    - job: MavenBuild
      displayName: Maven Build Job
      steps:

        - task: Maven@3
          displayName: Build WAR using Maven
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package'
            publishJUnitResults: false

        - task: CopyFiles@2
          displayName: Copy WAR to artifact folder
          inputs:
            SourceFolder: '$(System.DefaultWorkingDirectory)'
            Contents: '**/*.war'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/$(artifactName)'

        - task: PublishBuildArtifacts@1
          displayName: Publish WAR Artifact
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName)'
            ArtifactName: '$(artifactName)'


# ================================================================
#  QA DEPLOY STAGE
# ================================================================
- stage: QA
  displayName: Deploy to QA
  dependsOn: Build

  # This requires approval in Azure DevOps -> Environments
  environment: ProjectX-QA

  jobs:
    - deployment: DeployToQA
      displayName: Deploy WAR into QA Container
      environment: ProjectX-QA
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: warfiles

              - task: CmdLine@2
                displayName: Deploy WAR to QA via HTTP
                inputs:
                  script: |
                    echo "=== Locating WAR file ==="
                    WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)

                    if [ -z "$WAR_PATH" ]; then
                      echo "ERROR: WAR file not found!"
                      exit 1
                    fi

                    echo "WAR found at: $WAR_PATH"

                    AGENT_IP=$(hostname -I | awk '{print $1}')
                    echo "Agent IP: $AGENT_IP"

                    echo "=== Starting temp HTTP server ==="
                    cd "$(dirname "$WAR_PATH")"
                    python3 -m http.server 9000 &
                    HTTP_PID=$!
                    sleep 3

                    echo "=== Downloading WAR inside QA container using curl ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-qa \
                      --exec-command "curl -L -o /usr/local/tomcat/webapps/ROOT.war http://$AGENT_IP:9000/$(basename "$WAR_PATH")"

                    echo "=== Stopping HTTP server ==="
                    kill $HTTP_PID

                    echo "=== Restarting QA container ==="
                    az container restart \
                      --resource-group ProjectX-RG \
                      --name projectx-qa

                    echo "=== QA Deployment Completed Successfully ==="


# ================================================================
#  PROD DEPLOY STAGE
# ================================================================
- stage: PROD
  displayName: Deploy to PROD
  dependsOn: QA

  environment: ProjectX-PROD

  jobs:
    - deployment: DeployToProd
      displayName: Deploy WAR into PROD Container
      environment: ProjectX-PROD
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: warfiles

              - task: CmdLine@2
                displayName: Deploy WAR to PROD via HTTP
                inputs:
                  script: |
                    echo "=== Locating WAR file ==="
                    WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)

                    if [ -z "$WAR_PATH" ]; then
                      echo "ERROR: WAR file not found!"
                      exit 1
                    fi

                    echo "WAR found at: $WAR_PATH"

                    AGENT_IP=$(hostname -I | awk '{print $1}')
                    echo "Agent IP: $AGENT_IP"

                    echo "=== Starting temp HTTP server ==="
                    cd "$(dirname "$WAR_PATH")"
                    python3 -m http.server 9000 &
                    HTTP_PID=$!
                    sleep 3

                    echo "=== Downloading WAR inside PROD container using curl ==="
                    az container exec \
                      --resource-group ProjectX-RG \
                      --name projectx-prod \
                      --exec-command "curl -L -o /usr/local/tomcat/webapps/ROOT.war http://$AGENT_IP:9000/$(basename "$WAR_PATH")"

                    echo "=== Stopping HTTP server ==="
                    kill $HTTP_PID

                    echo "=== Restarting PROD container ==="
                    az container restart \
                      --resource-group ProjectX-RG \
                      --name projectx-prod

                    echo "=== PROD Deployment Completed Successfully ==="
