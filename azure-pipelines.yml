trigger:
  - master

pool:
  name: SelfHostedPool

variables:
  maven.opts: "-Dmaven.repo.local=$(Pipeline.Workspace)/.m2"

stages:
# ==========================
#        BUILD STAGE
# ==========================
- stage: Build
  displayName: "Build and Package"

  jobs:
  - job: BuildJob
    steps:
    - task: Maven@3
      inputs:
        mavenPomFile: 'webapp/pom.xml'
        goals: 'clean package'
        options: '$(maven.opts)'
      displayName: "Build Maven Project"

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'webapp/target'
        artifact: 'warfiles'
      displayName: "Publish WAR Artifact"

# ===========================
#        QA STAGE
# ===========================
- stage: QA
  displayName: "Deploy to QA"
  dependsOn: Build

  jobs:
  - job: DeployQA
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "Locating WAR file..."
        WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)

        if [ -z "$WAR_PATH" ]; then
          echo "WAR NOT FOUND"
          exit 1
        fi

        echo "WAR located at: $WAR_PATH"
        echo "Deploying using Dockerized Azure CLI..."

        echo "Ensuring deployment directory exists inside QA container..."
        docker run --rm \
          mcr.microsoft.com/azure-cli:latest \
          az container exec \
            --resource-group ProjectX-RG \
            --name projectx-qa \
            --exec-command "mkdir -p /usr/local/tomcat/webapps"

        echo "Copying WAR into QA container..."
        docker run --rm \
          -v "$WAR_PATH":/warfile.war \
          mcr.microsoft.com/azure-cli:latest \
          az container cp /warfile.war ProjectX-RG/projectx-qa:/usr/local/tomcat/webapps/ROOT.war

        echo "Restarting QA container..."
        docker run --rm \
          mcr.microsoft.com/azure-cli:latest \
          az container restart --resource-group ProjectX-RG --name projectx-qa

        echo "QA Deployment done."
      displayName: "Deploy to QA"

# ===========================
#       PROD STAGE
# ===========================
- stage: PROD
  displayName: "Deploy to PROD"
  dependsOn: QA

  # Require manual approval in Azure DevOps > Environments
  condition: succeeded()

  jobs:
  - job: DeployProd
    steps:

    - download: current
      artifact: warfiles

    - script: |
        echo "Locating WAR file..."
        WAR_PATH=$(find "$(Pipeline.Workspace)/warfiles" -name "*.war" | head -n 1)

        if [ -z "$WAR_PATH" ]; then
          echo "WAR NOT FOUND"
          exit 1
        fi

        echo "WAR located at: $WAR_PATH"
        echo "Deploying using Dockerized Azure CLI..."

        echo "Ensuring deployment directory exists inside PROD container..."
        docker run --rm \
          mcr.microsoft.com/azure-cli:latest \
          az container exec \
            --resource-group ProjectX-RG \
            --name projectx-prod \
            --exec-command "mkdir -p /usr/local/tomcat/webapps"

        echo "Copying WAR into PROD container..."
        docker run --rm \
          -v "$WAR_PATH":/warfile.war \
          mcr.microsoft.com/azure-cli:latest \
          az container cp /warfile.war ProjectX-RG/projectx-prod:/usr/local/tomcat/webapps/ROOT.war

        echo "Restarting PROD container..."
        docker run --rm \
          mcr.microsoft.com/azure-cli:latest \
          az container restart --resource-group ProjectX-RG --name projectx-prod

        echo "PROD Deployment done."
      displayName: "Deploy to PROD"
