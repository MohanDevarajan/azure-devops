trigger:
- main

pool:
  name: SelfHostedPool

stages:
# =====================================================================
# STAGE 1 → BUILD
# =====================================================================
- stage: Build
  displayName: "Build WAR"
  jobs:
  - job: BuildJob
    displayName: "Maven Build"
    steps:

    - task: Maven@4
      displayName: "Maven Package"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"

    - script: |
        mkdir -p $(Build.ArtifactStagingDirectory)/warfiles
        cp target/*.war $(Build.ArtifactStagingDirectory)/warfiles/webapp.war
      displayName: "Copy WAR to Artifact Folder"

    - publish: $(Build.ArtifactStagingDirectory)/warfiles
      artifact: warfiles


# =====================================================================
# STAGE 2 → DEPLOY TO QA
# =====================================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Build

  jobs:
  - deployment: DeployToQA
    displayName: "Deploy to QA Container"
    environment: QA     # <- must match environment created in Azure DevOps
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: warfiles

          - script: |
              set -e

              echo "=== Locating WAR file ==="
              WAR_PATH="$(System.DefaultWorkingDirectory)/warfiles/webapp.war"
              echo "WAR: $WAR_PATH"

              echo "=== Encoding WAR ==="
              base64 "$WAR_PATH" > war.b64

              echo "=== Prepare QA container ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-qa \
                --exec-command "mkdir -p /tmp/deploy"

              echo "=== Upload Base64 WAR ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-qa \
                --exec-command "cat > /tmp/deploy/ROOT.b64" < war.b64

              echo "=== Decode WAR inside QA ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-qa \
                --exec-command "base64 -d /tmp/deploy/ROOT.b64 > /tmp/deploy/ROOT.war"

              echo "=== Move WAR to Tomcat Webapps ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-qa \
                --exec-command "mv /tmp/deploy/ROOT.war /usr/local/tomcat/webapps/ROOT.war"

              echo "=== Restart QA Container ==="
              az container restart \
                --resource-group ProjectX-RG \
                --name projectx-qa

              echo "QA Deployment DONE"
            displayName: "Deploy WAR to TOMCAT 11 (QA)"


# =====================================================================
# STAGE 3 → MANUAL APPROVAL GATE
# =====================================================================
- stage: ApprovalGate
  displayName: "Manual Approval Before PROD"
  dependsOn: Deploy_QA

  jobs:
  - job: WaitForApproval
    displayName: "Manual Approval"
    pool: server  # <- REQUIRED
    steps:
    - task: ManualValidation@0
      displayName: "Approve Deploy to PROD"
      inputs:
        instructions: "Please approve promotion of QA build to PROD."
        onTimeout: "reject"   # optional


# =====================================================================
# STAGE 4 → DEPLOY TO PROD
# =====================================================================
- stage: Deploy_PROD
  displayName: "Deploy to PROD"
  dependsOn: ApprovalGate

  jobs:
  - deployment: DeployToPROD
    displayName: "Deploy to PROD Container"
    environment: PROD     # <- must match Azure DevOps environment name
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: warfiles

          - script: |
              set -e

              echo "=== Locating WAR file ==="
              WAR_PATH="$(System.DefaultWorkingDirectory)/warfiles/webapp.war"
              echo "WAR: $WAR_PATH"

              echo "=== Encoding WAR ==="
              base64 "$WAR_PATH" > war.b64

              echo "=== Prepare PROD container ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-prod \
                --exec-command "mkdir -p /tmp/deploy"

              echo "=== Upload Base64 WAR ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-prod \
                --exec-command "cat > /tmp/deploy/ROOT.b64" < war.b64

              echo "=== Decode WAR inside PROD ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-prod \
                --exec-command "base64 -d /tmp/deploy/ROOT.b64 > /tmp/deploy/ROOT.war"

              echo "=== Move WAR to Tomcat Webapps ==="
              az container exec \
                --resource-group ProjectX-RG \
                --name projectx-prod \
                --exec-command "mv /tmp/deploy/ROOT.war /usr/local/tomcat/webapps/ROOT.war"

              echo "=== Restart PROD Container ==="
              az container restart \
                --resource-group ProjectX-RG \
                --name projectx-prod

              echo "PROD Deployment DONE"
            displayName: "Deploy WAR to TOMCAT 11 (PROD)"
